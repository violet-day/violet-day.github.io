<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.5.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="nodejs,generic-pool," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.5.0" />






<meta name="description" content="前言对象池作为一种设计模式，很多语言都有对应的实现。比较著名的应该就是commons-pool。实际开发中，可能接触的比较的多的就是db的连接池。以下摘自wiki：

   The object pool pattern is a software creational design pattern that uses a set of initialized objects kept ready">
<meta property="og:type" content="article">
<meta property="og:title" content="object-pool实现之node版本分析">
<meta property="og:url" content="http://violet-day.github.io/2017/03/02/object-pool-node-version/index.html">
<meta property="og:site_name" content="Nemo's Blog">
<meta property="og:description" content="前言对象池作为一种设计模式，很多语言都有对应的实现。比较著名的应该就是commons-pool。实际开发中，可能接触的比较的多的就是db的连接池。以下摘自wiki：

   The object pool pattern is a software creational design pattern that uses a set of initialized objects kept ready">
<meta property="og:image" content="http://violet-day.github.io/images/generic-pool.jpeg">
<meta property="og:updated_time" content="2017-03-04T14:56:55.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="object-pool实现之node版本分析">
<meta name="twitter:description" content="前言对象池作为一种设计模式，很多语言都有对应的实现。比较著名的应该就是commons-pool。实际开发中，可能接触的比较的多的就是db的连接池。以下摘自wiki：

   The object pool pattern is a software creational design pattern that uses a set of initialized objects kept ready">
<meta name="twitter:image" content="http://violet-day.github.io/images/generic-pool.jpeg">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 6218687468384814000,
      author: '博主'
    }
  };
</script>

  <title> object-pool实现之node版本分析 | Nemo's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-67357558-7', 'auto');
  ga('send', 'pageview');
</script>







  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Nemo's Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">Ride The Lightning</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      

      
      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                object-pool实现之node版本分析
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-03-02T21:25:19+08:00" content="Mar 2 2017">
              Mar 2 2017
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/03/02/object-pool-node-version/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/03/02/object-pool-node-version/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>对象池作为一种设计模式，很多语言都有对应的实现。比较著名的应该就是<a href="https://github.com/apache/commons-pool" target="_blank" rel="external">commons-pool</a>。实际开发中，可能接触的比较的多的就是db的连接池。以下摘自<a href="https://en.wikipedia.org/wiki/Object_pool_pattern" target="_blank" rel="external">wiki</a>：</p>
<blockquote>
<p>   The object pool pattern is a software creational design pattern that uses a set of initialized objects kept ready to use – a “pool” – rather than allocating and destroying them on demand. A client of the pool will request an object from the pool and perform operations on the returned object. When the client has finished, it returns the object to the pool rather than destroying it; this can be done manually or automatically.<br>   Object pools are primarily used for performance: in some circumstances, object pools significantly improve performance. Object pools complicate object lifetime, as objects obtained from and returned to a pool are not actually created or destroyed at this time, and thus require care in implementation.</p>
</blockquote>
<p>通过<a href="https://github.com/coopernurse/node-pool" target="_blank" rel="external">node-pool</a>简单了解下<code>object-pool</code>的具体实现</p>
<h2 id="Project-Struct"><a href="#Project-Struct" class="headerlink" title="Project Struct"></a>Project Struct</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">├── CHANGELOG.md</div><div class="line">├── Makefile</div><div class="line">├── README.md</div><div class="line">├── index.js</div><div class="line">├── lib</div><div class="line">│   ├── DefaultEvictor.js</div><div class="line">│   ├── Deferred.js</div><div class="line">│   ├── Deque.js</div><div class="line">│   ├── DequeIterator.js</div><div class="line">│   ├── DoublyLinkedList.js</div><div class="line">│   ├── DoublyLinkedListIterator.js</div><div class="line">│   ├── Pool.js</div><div class="line">│   ├── PoolDefaults.js</div><div class="line">│   ├── PoolOptions.js</div><div class="line">│   ├── PooledResource.js</div><div class="line">│   ├── PooledResourceStateEnum.js</div><div class="line">│   ├── PriorityQueue.js</div><div class="line">│   ├── Queue.js</div><div class="line">│   ├── ResourceLoan.js</div><div class="line">│   ├── ResourceRequest.js</div><div class="line">│   ├── errors.js</div><div class="line">│   ├── factoryValidator.js</div><div class="line">│   └── utils.js</div><div class="line">├── package.json</div><div class="line">└── test</div><div class="line">    ├── doubly-linked-list-iterator-test.js</div><div class="line">    ├── doubly-linked-list-test.js</div><div class="line">    ├── generic-pool-acquiretimeout-test.js</div><div class="line">    ├── generic-pool-test.js</div><div class="line">    ├── resource-request-test.js</div><div class="line">    └── utils.js</div></pre></td></tr></table></figure>
<p>整个结构可以划分如下：</p>
<ul>
<li>基本数据结构<ul>
<li>DoublyLinkedList.js <a href="https://en.wikipedia.org/wiki/Doubly_linked_list" target="_blank" rel="external">双链表</a></li>
<li>DoublyLinkedListIterator.js</li>
<li>Deque.js <a href="https://en.wikipedia.org/wiki/Double-ended_queue" target="_blank" rel="external">双端对列</a></li>
<li>DequeIterator.js</li>
<li>Queue.js </li>
<li>PriorityQueue.js</li>
</ul>
</li>
<li>Promise相关的封装<ul>
<li>Deferred.js</li>
</ul>
</li>
<li>Pool相关<ul>
<li>PooledResource.js</li>
<li>PooledResourceStateEnum.js</li>
<li>ResourceRequest.js</li>
<li>ResourceLoan.js</li>
<li>PoolDefaults.js</li>
<li>PoolOptions.js</li>
<li>DefaultEvictor.js 默认的evictor policy实现</li>
<li>Pool.js pool的主要逻辑实现</li>
</ul>
</li>
</ul>
<p><img src="/images/generic-pool.jpeg" alt=""></p>
<h2 id="pool-js"><a href="#pool-js" class="headerlink" title="pool.js"></a>pool.js</h2><h3 id="attribute"><a href="#attribute" class="headerlink" title="attribute"></a>attribute</h3><ul>
<li>waitingClientsQueue:ProtorityQueue 请求资源中的clients</li>
<li>factoryCreateOperations:Set<promise> 正在处理的创建资源的请求</promise></li>
<li>factoryDestroyOperations:Set<promise> 正在处理的销毁资源的请求</promise></li>
<li>avaiableObjects:Deque 状态为idel的资源，因为存在fifo的配置选项，所以存储时选择的数据结构为双端对列</li>
<li>testOnBorrowResources:Set 在获取之前处于testing中的资源</li>
<li>testOnReturnResources:Set 在返回pool之前的testing资源</li>
<li>validationOperations: Set<promise></promise></li>
<li>allObjects:Set 当前pool中所有的没有被destroy的资源</li>
<li>resourceLoans：Map，结构为<resource,loan></resource,loan></li>
</ul>
<p>xxxOperations:Set<promise>的作用为暂存执行create、desitory、validation中的请求</promise></p>
<h4 id="getter"><a href="#getter" class="headerlink" title="getter"></a>getter</h4><ul>
<li>potentiallyAllocableResourceCount： 可以被分配的资源的数量，为以下之和<ul>
<li>availableObjects</li>
<li>testOnBorrowResources</li>
<li>testOnReturnResources</li>
<li>factoryCreateOperations</li>
</ul>
</li>
<li>count = allObjects + factoryCreateOperations：当前已经创建的资源和即将创建的资源之和</li>
<li>spareResourceCapacity = config.max - count：当前还可以创建的数量</li>
</ul>
<h4 id="function"><a href="#function" class="headerlink" title="function"></a>function</h4><p><strong>dispatchPooledResourceToNextWaitingClient(pooledResource)</strong></p>
<ol>
<li>从watingClientQueue dequeue一个request，如果request不存在，则将resource标记为idle并添加至availableObjects中，返回fasle</li>
<li>如果存在request，构造ResourceLoan，并添加loan对象至resourceLoans中</li>
<li>pooledResouce标记为allocated</li>
<li>执行request.resolve</li>
<li>返回true</li>
</ol>
<p><strong>dispatchResource(pooledResouce)</strong></p>
<ol>
<li>从availableObjects中取出resource，并执行dispatchPooledResourceToNextWaitingClient</li>
</ol>
<p><strong>dispense()</strong></p>
<ol>
<li>记录waitingClientsQueue.length为局部变numWaitingClients，如果numWaitingClients&lt;1则直接return</li>
<li>记录numWaitingClients-potentiallyAllocableResourceCount的差值为resourceShotfall，即对于watingClient实际缺少的resource的数量</li>
<li>resourceShotfall和spareResourceCapacity中取最小值，即本次执行函数时，可以创建resource的数量</li>
<li>for循环执行createResource</li>
<li>testOnBorrow设置为true，计算出实际多少resource需要转入test状态，for循环执行testOnBorrow</li>
<li>testOnBorrow设置为false时，取availableObjects和numWaitingClients中较小的数值，for循环执行dispatchResource</li>
</ol>
<p><strong>createResource()</strong></p>
<ol>
<li>执行factory.create，resolve之后<ol>
<li>构造PooledResource实例</li>
<li>allObjects.add</li>
<li>dispatchPooledResourceToNextWaitingClient</li>
</ol>
</li>
<li>如果reject，则执行dispense，实现递归</li>
</ol>
<p><strong>testOnBorrow()</strong></p>
<ol>
<li>availableObjects中取出resource并标记状态为test</li>
<li>添加址testOnBorrowResources中</li>
<li>执行factory.validate，promise reoslve的结果为boolean类型，resolve结束时，从testOnBorrowResources移除<ol>
<li>结果为true，执行dispatchPooledResourceToNextWaitingClient</li>
<li>结果为false，标记resource为invalidate；destroy resource；dispense，实现递归</li>
</ol>
</li>
</ol>
<p><strong>acqurie(priority)</strong></p>
<ol>
<li>判断是否draining，如果是则reject error</li>
<li>判断waitingClientsQueue是否已经大于maxWaitingClients，如果是，则reject error</li>
<li>构造ResourceRequest，并enqueue至waitingClientsQueue中</li>
<li>执行dispense</li>
<li>返回resourceRequest.promise</li>
</ol>
<p><strong>release(resource)</strong></p>
<ol>
<li>在createResource的逻辑中，会讲分配出去的resource添加至resourceLoans中，release的主要作用也是从resourceLoans将resouce移除</li>
<li>标记resource状态为idel，并归还至availableObjects</li>
</ol>
<h2 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h2><ol>
<li>整个项目3.x版本重构过了，使用了es6的class来构建模块，可以通过类图理解结构，好评</li>
<li>factory接口中定义的create、destory、validate的均为异步函数，关于在判断数量时均需要考虑正在create、destory和validte的数量。这里是factory中的promise通过set保存</li>
<li>resource对象有很多状态，对应的pool中就要有相应的容器来存放相应状态的resource或者promise，理解pool的关键就在此。</li>
<li>感觉好难用图来表述逻辑，只能用文字了。</li>
</ol>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a href="https://github.com/coopernurse/node-pool" target="_blank" rel="external">Generic Pool</a></li>
<li><a href="https://github.com/apache/commons-pool" target="_blank" rel="external">commons-pool</a></li>
</ul>

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/nodejs/" rel="tag">#nodejs</a>
          
            <a href="/tags/generic-pool/" rel="tag">#generic-pool</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/01/25/statsd/" rel="next" title="statsd源码笔记">
                <i class="fa fa-chevron-left"></i> statsd源码笔记
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        <div class="ds-share flat" data-thread-key="2017/03/02/object-pool-node-version/"
     data-title="object-pool实现之node版本分析"
     data-content=""
     data-url="http://violet-day.github.io/2017/03/02/object-pool-node-version/">
  <div class="ds-share-inline">
    <ul  class="ds-share-icons-16">

      <li data-toggle="ds-share-icons-more"><a class="ds-more" href="javascript:void(0);">分享到：</a></li>
      <li><a class="ds-weibo" href="javascript:void(0);" data-service="weibo">微博</a></li>
      <li><a class="ds-qzone" href="javascript:void(0);" data-service="qzone">QQ空间</a></li>
      <li><a class="ds-qqt" href="javascript:void(0);" data-service="qqt">腾讯微博</a></li>
      <li><a class="ds-wechat" href="javascript:void(0);" data-service="wechat">微信</a></li>

    </ul>
    <div class="ds-share-icons-more">
    </div>
  </div>
</div>
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2017/03/02/object-pool-node-version/"
           data-title="object-pool实现之node版本分析" data-url="http://violet-day.github.io/2017/03/02/object-pool-node-version/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://avatars2.githubusercontent.com/u/5970246?v=3&s=460"
               alt="violet_day" />
          <p class="site-author-name" itemprop="name">violet_day</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">26</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>
          
          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">8</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">36</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/violet-day" target="_blank">
                  
                    <i class="fa fa-github"></i> GitHub
                  
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator">
            <i class="fa fa-angle-double-up"></i>
          </div>
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Project-Struct"><span class="nav-number">2.</span> <span class="nav-text">Project Struct</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#pool-js"><span class="nav-number">3.</span> <span class="nav-text">pool.js</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#attribute"><span class="nav-number">3.1.</span> <span class="nav-text">attribute</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#getter"><span class="nav-number">3.1.1.</span> <span class="nav-text">getter</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#function"><span class="nav-number">3.1.2.</span> <span class="nav-text">function</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结："><span class="nav-number">4.</span> <span class="nav-text">总结：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Reference"><span class="nav-number">5.</span> <span class="nav-text">Reference</span></a></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator">
            <i class="fa fa-angle-double-down"></i>
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">violet_day</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  


  



  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=0.5.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=0.5.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=0.5.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=0.5.0"></script>



  
  
<script type="text/javascript" src="/js/src/scrollspy.js?v=0.5.0"></script>

<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.motion.complete', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      var $indicator = $(indicator);
      var opacity = action === 'show' ? 1 : 0;
      $indicator.velocity ?
        $indicator.velocity('stop').velocity({
          opacity: opacity
        }, { duration: 100 }) :
        $indicator.stop().animate({
          opacity: opacity
        }, 100);
    }

  });
</script>

<script type="text/javascript" id="sidebar.nav">
  $(document).ready(function () {
    var html = $('html');
    var TAB_ANIMATE_DURATION = 200;
    var hasVelocity = $.isFunction(html.velocity);

    $('.sidebar-nav li').on('click', function () {
      var item = $(this);
      var activeTabClassName = 'sidebar-nav-active';
      var activePanelClassName = 'sidebar-panel-active';
      if (item.hasClass(activeTabClassName)) {
        return;
      }

      var currentTarget = $('.' + activePanelClassName);
      var target = $('.' + item.data('target'));

      hasVelocity ?
        currentTarget.velocity('transition.slideUpOut', TAB_ANIMATE_DURATION, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', TAB_ANIMATE_DURATION)
            .addClass(activePanelClassName);
        }) :
        currentTarget.animate({ opacity: 0 }, TAB_ANIMATE_DURATION, function () {
          currentTarget.hide();
          target
            .stop()
            .css({'opacity': 0, 'display': 'block'})
            .animate({ opacity: 1 }, TAB_ANIMATE_DURATION, function () {
              currentTarget.removeClass(activePanelClassName);
              target.addClass(activePanelClassName);
            });
        });

      item.siblings().removeClass(activeTabClassName);
      item.addClass(activeTabClassName);
    });

    $('.post-toc a').on('click', function (e) {
      e.preventDefault();
      var targetSelector = NexT.utils.escapeSelector(this.getAttribute('href'));
      var offset = $(targetSelector).offset().top;
      hasVelocity ?
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        }) :
        $('html, body').stop().animate({
          scrollTop: offset
        }, 500);
    });

    // Expand sidebar on post detail page by default, when post has a toc.
    NexT.motion.middleWares.sidebar = function () {
      var $tocContent = $('.post-toc-content');

      if (CONFIG.sidebar.display === 'post' || CONFIG.sidebar.display === 'always') {
        if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
          NexT.utils.displaySidebar();
        }
      }
    };
  });
</script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=0.5.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"Nemo"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
  





  
  

  
  


</body>
</html>
